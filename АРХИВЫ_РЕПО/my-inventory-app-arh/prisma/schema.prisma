// schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Supplier {
  id   Int    @id @default(autoincrement())
  name String @unique

  productUnits ProductUnit[]

  @@map("suppliers")
}

model Customer {
  id    Int    @id @default(autoincrement())
  name  String
  phone String?
  notes String?

  productUnits ProductUnit[]

  @@map("customers")
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  name  String?
}

model Category {
  id       Int       @id @default(autoincrement())
  name     String
  slug     String    @unique
  path     String    @unique

  // –ù–û–í–´–ï –ü–û–õ–Ø –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∏–Ω–¥–µ–∫—Å–æ–≤
  node_index   String?   @unique  // "0_1V01_2V03_3V01" - –º–∞—à–∏–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
  human_path   String?             // "/–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–†—É—á–Ω–æ–π/–ë–∏—Ç—ã/10–º–º" - —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –ø—É—Ç—å
  parent_id    Int?                // —Ä–µ–∑–µ—Ä–≤–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
  products Product[]
  spines   Spine[]

  // –°–í–Ø–ó–¨ –î–õ–Ø parent_id
  parent   Category?   @relation("CategoryChildren", fields: [parent_id], references: [id])
  children Category[]  @relation("CategoryChildren")

  stockTrafficLights StockTrafficLight[]

  @@map("categories")
  @@index([path])
  @@index([node_index])           // –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ node_index
  @@index([parent_id])            // –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Å–≤—è–∑–µ–π
}

model Brand {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products Product[]

  @@map("brands")
}

model Product {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  name        String
  description String?
  categoryId  Int?
  category    Category? @relation(fields: [categoryId], references: [id])
  brandId     Int
  brand       Brand    @relation(fields: [brandId], references: [id])
  spineId     Int?
  spine       Spine?    @relation(fields: [spineId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // –ù–û–í–´–ï –ü–û–õ–Ø –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∏–Ω–¥–µ–∫—Å–æ–≤
  node_index   String?   @unique  // "0_1V01_2V03_3V01_S[kluch_10mm]_P[f75510]"
  human_path   String?             // "/–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–†—É—á–Ω–æ–π/–ë–∏—Ç—ã/10–º–º/–ö–ª—é—á 10–º–º/–ê—Ä—Ç. f75510"

  // –°–í–Ø–ó–ò (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
  images       ProductImage[]
  productUnits ProductUnit[]

  @@map("products")
  @@index([node_index])  // –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  filename  String
  path      String
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())
  localPath String?
  githubUrl String?
  storageType String @default("local")

  @@map("product_images")
}


enum UnitDisassemblyStatus {
  MONOLITH
  DISASSEMBLED
  PARTIAL
  COLLECTED
  RESTORED
}

enum ProductUnitCardStatus {
  CLEAR
  CANDIDATE
  SPROUTED
  IN_REQUEST
  IN_DELIVERY
  ARRIVED
}

enum ProductUnitPhysicalStatus {
  IN_STORE
  SOLD
  CREDIT
  LOST
  IN_DISASSEMBLED
  IN_COLLECTED
}

// –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–∞–∑–±–æ—Ä–∫–∏
model DisassemblyScenario {
  id        Int    @id @default(autoincrement())
  name      String
  parentProductCode String  
  childProductCodes Json    
  partsCount Int
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productUnits ProductUnit[]

  @@map("disassembly_scenarios")
  @@unique([parentProductCode, name]) 
}

model ProductUnit {
  id           Int      @id @default(autoincrement())
  serialNumber String   @unique @map("serial_number")
  productId    Int
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  spineId      Int?
  spine        Spine?   @relation(fields: [spineId], references: [id])

  parentProductUnitId Int?
  parentProductUnit   ProductUnit? @relation("ProductUnitChildren", fields: [parentProductUnitId], references: [id])
  childProductUnits   ProductUnit[] @relation("ProductUnitChildren")

  productCode         String? @map("product_code")
  productName         String? @map("product_name")
  productDescription  String? @map("product_description")
  productCategoryId   Int?    @map("product_category_id")
  productCategoryName String? @map("product_category_name")
  productTags         Json?   @map("product_tags")

  quantityInCandidate Int?       @default(0) @map("quantity_in_candidate")
  createdAtCandidate  DateTime?  @map("created_at_candidate")
  quantityInRequest   Int?       @default(0) @map("quantity_in_request")
  createdAtRequest    DateTime?  @map("created_at_request")
  requestPricePerUnit Float?     @map("request_price_per_unit")

  statusCard          ProductUnitCardStatus
  statusProduct       ProductUnitPhysicalStatus?
  isReturned          Boolean   @default(false)
  returnedAt          DateTime? @map("returned_at")

  salePrice    Float?    @map("sale_price")
  soldAt       DateTime? @map("sold_at")
  isCredit     Boolean   @default(false) @map("is_credit")
  creditPaidAt DateTime? @map("credit_paid_at")

  supplierId Int?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])
  customerId Int?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–∞–∑–±–æ—Ä–∫–∏/—Å–±–æ—Ä–∫–∏
  disassemblyStatus      UnitDisassemblyStatus @default(MONOLITH)
  disassembledParentId   Int?
  disassembledParent     ProductUnit? @relation("DisassemblyParent", fields: [disassembledParentId], references: [id])
  disassemblyScenarioId  Int? // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û –ü–û–õ–ï
  disassemblyScenario    DisassemblyScenario? @relation(fields: [disassemblyScenarioId], references: [id]) // ‚Üê –ò–°–ü–†–ê–í–ò–¢–¨
  isParsingAlgorithm     Boolean @default(false)
  partialChildren        ProductUnit[] @relation("DisassemblyParent")

  logs        ProductUnitLog[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  cashEvents  CashEvent[]

  inventorySnapshots InventorySnapshot[]
  salesHistory       ProductSalesHistory[]
  inventoryForecasts InventoryForecast[]   
  reorderPoints      ReorderPoint[]        

  @@map("product_units")
}

model CashDay {
  id        Int       @id @default(autoincrement())
  date      DateTime  @unique @map("date")
  isClosed  Boolean   @default(false) @map("is_closed")
  total     Float     @default(0.00) @map("total")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  events CashEvent[]

  @@map("cash_days")
}

model CashEvent {
  id        Int           @id @default(autoincrement())
  type      CashEventType @map("type")
  amount    Float         @map("amount")
  notes     String?       @map("notes")
  cashDayId Int           @map("cash_day_id")
  cashDay   CashDay       @relation(fields: [cashDayId], references: [id], onDelete: Cascade)
  productUnitId Int?      @map("product_unit_id")
  productUnit   ProductUnit? @relation(fields: [productUnitId], references: [id], onDelete: SetNull)
  createdAt DateTime      @default(now()) @map("created_at")

  salesHistory ProductSalesHistory[]

  @@map("cash_events")
}

enum CashEventType {
  SALE
  RETURN
  PRICE_QUERY
  ORDER
}

model Spine {
  id         Int        @id @default(autoincrement())
  name       String
  slug       String     @unique
  categoryId Int?
  category   Category?  @relation(fields: [categoryId], references: [id])
  imagePath  String?
  brandData  Json?      @db.Json
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // –ù–û–í–´–ï –ü–û–õ–Ø –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∏–Ω–¥–µ–∫—Å–æ–≤
  node_index   String?   @unique  // "0_1V01_2V03_3V01_S[kluch_10mm]"
  human_path   String?             // "/–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–†—É—á–Ω–æ–π/–ë–∏—Ç—ã/10–º–º/–ö–ª—é—á 10–º–º"

  // –°–í–Ø–ó–ò (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
  products     Product[]
  productUnits ProductUnit[]

  @@map("spines")
  @@index([node_index])  // –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
}

model ProductUnitLog {
  id            Int         @id @default(autoincrement())
  productUnitId Int
  productUnit   ProductUnit @relation(fields: [productUnitId], references: [id], onDelete: Cascade)
  type          String?
  message       String
  meta          Json?
  createdAt     DateTime    @default(now())

  @@map("product_unit_logs")
}

model InventorySnapshot {
  id            Int      @id @default(autoincrement())
  snapshotDate  DateTime
  
  // –°–í–Ø–ó–¨ –° PRODUCT_UNIT –î–õ–Ø –î–ï–¢–ê–õ–¨–ù–û–ô –ê–ù–ê–õ–ò–¢–ò–ö–ò
  productUnitId Int?
  productUnit   ProductUnit? @relation(fields: [productUnitId], references: [id])
  
  // –î–ê–ù–ù–´–ï –ù–ê –ú–û–ú–ï–ù–¢ –°–ù–ò–ú–ö–ê
  statusProduct ProductUnitPhysicalStatus? // –°—Ç–∞—Ç—É—Å –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–Ω–∏–º–∫–∞
  salePrice     Float?                     // –¶–µ–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–Ω–∏–º–∫–∞
  stockValue    Float?                     // –°—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–æ–π –µ–¥–∏–Ω–∏—Ü—ã
  
  periodType    String // "daily", "weekly", "monthly"
  
  createdAt DateTime @default(now())
  
  @@map("inventory_snapshots")
  @@unique([snapshotDate, productUnitId, periodType])
}

model ProductSalesHistory {
  id          Int      @id @default(autoincrement())
  
  // –°–í–Ø–ó–¨ –° PRODUCT_UNIT (–∫–∞–∫–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø—Ä–æ–¥–∞–Ω–∞)
  productUnitId Int
  productUnit   ProductUnit @relation(fields: [productUnitId], references: [id])
  
  // –°–í–Ø–ó–¨ –° CASH_EVENT (—Ñ–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏)
  cashEventId   Int
  cashEvent     CashEvent @relation(fields: [cashEventId], references: [id])
  
  periodDate  DateTime // –î–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞ –ø—Ä–æ–¥–∞–∂–∏
  periodType  String   // "daily", "weekly", "monthly"
  
  // –î–ê–ù–ù–´–ï –ü–†–û–î–ê–ñ–ò
  salePrice    Float   // –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏
  soldAt       DateTime // –î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏
  
  createdAt DateTime @default(now())
  
  @@map("product_sales_history")
  @@unique([productUnitId, cashEventId])
}

model InventoryForecast {
  id          Int      @id @default(autoincrement())
  
  // –°–í–Ø–ó–¨ –° PRODUCT_UNIT (–∞ –Ω–µ —Å Product)
  productUnitId Int
  productUnit   ProductUnit @relation(fields: [productUnitId], references: [id])
  
  forecastDate DateTime
  periodStart  DateTime
  periodEnd    DateTime
  periodType   String
  
  predictedSales Int
  recommendedOrder Int
  confidence     Float
  actualSales    Int?
  accuracy       Float?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("inventory_forecasts")
  @@unique([productUnitId, periodStart, periodType])
}

model ReorderPoint {
  id          Int      @id @default(autoincrement())
  
  // –°–í–Ø–ó–¨ –° PRODUCT_UNIT (–∞ –Ω–µ —Å Product)
  productUnitId Int
  productUnit   ProductUnit @relation(fields: [productUnitId], references: [id])
  
  minStock    Int
  maxStock    Int
  reorderQty  Int
  leadTime    Int
  safetyStock Int
  
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("reorder_points")
  @@unique([productUnitId])
}

model StockTrafficLight {
  id          Int      @id @default(autoincrement())
  productCode String   @unique
  brandName   String
  minStock    Int      @default(1)    // üî¥ –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –º–µ–Ω—å—à–µ
  normalStock Int      @default(2)    // üü° –ñ–µ–ª—Ç—ã–π –µ—Å–ª–∏ –º–µ–Ω—å—à–µ  
  goodStock   Int      @default(3)    // üü¢ –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ –±–æ–ª—å—à–µ
  weeklySales Int      @default(0)    // –ü—Ä–æ–¥–∞–Ω–æ –∑–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
  categoryId  Int?
  category    Category? @relation(fields: [categoryId], references: [id]) // ‚Üê —Å–≤—è–∑—å —Å Category
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("stock_traffic_lights")
}